<!DOCTYPE html>
<html>
  <head>
    <script id="vertex-shader" type="x-shader/x-vertex">
      precision mediump float;
      attribute vec4 vertexPosition;
      uniform mat4 modelViewMatrix;
      uniform mat4 projectionMatrix;

      attribute vec3 nv; // normal vector

      // uniforms:
      // point light source location
      uniform vec3 p0;
      // incident light components
      uniform vec3 Ia, Id, Is;
      // coefficients of object
      uniform vec3 ka, kd, ks;
      // shininess for specular light
      uniform float alpha;

      uniform vec3 lightDirection; // The direction in which the light is shining
      uniform float cutoffAngle; // The cutoff angle for the spotlight in radians

      // attenuated incident light components
      vec3 Ia_pp0, Id_pp0, Is_pp0;
      // unit vectors for source direction and view
      vec3 i, v;
      // reflection light
      // (interpolated in fragment shader)
      varying vec3 R;


      void main() {
      	gl_PointSize = 1.0;
      	// Compute point light source attenuated
      	float distance = length(vertexPosition.xyz - p0);

      	// Compute the direction from the vertex to the light source
      	vec3 directionToLightSource = normalize(p0 - vertexPosition.xyz);

      	// Compute the angle between the direction to the light source and the light direction
      	float angle = acos(dot(directionToLightSource, lightDirection));

      	// If the angle is less than the cutoff angle, the vertex is lit by the spotlight
      	if (angle < cutoffAngle) {
      		// Ambient, diffuse, and specular light attenuated
      		Ia_pp0 = Ia / (distance * distance);
      		Id_pp0 = Id / (distance * distance);
      		Is_pp0 = Is / (distance * distance);

      		vec3 Ra, Rd, Rs;  // reflection light components

      		// Ambient Reflection
      		Ra.r = ka.r * Ia_pp0.r;
      		Ra.g = ka.g * Ia_pp0.g;
      		Ra.b = ka.b * Ia_pp0.b;

      		// Diffuse Reflection
      		i = normalize(p0 - vertexPosition.xyz);
      		float costheta = dot(i,nv);
      		Rd.r = kd.r * Id_pp0.r * max(costheta, 0.0);
      		Rd.g = kd.g * Id_pp0.g * max(costheta, 0.0);
      		Rd.b = kd.b * Id_pp0.b * max(costheta, 0.0);

      		// Specular Reflection
      		vec3 r = normalize(2.0 * nv * costheta - i);
      		v = normalize(vec3(0.0, 0.0, 0.0) - vertexPosition.xyz);
      		float cosphi = dot(r,v);
      		float shine = pow(max(cosphi, 0.0), alpha);
      		float costhetag0 = floor(0.5 * (sign(costheta)+1.0));
      		Rs.r = ks.r * Is_pp0.r * shine * costhetag0;
      		Rs.g = ks.g * Is_pp0.g * shine * costhetag0;
      		Rs.b = ks.b * Is_pp0.b * shine * costhetag0;

      		// Final reflection: sum of ambient, diffuse, and specular
      		R = clamp( Ra + Rd + Rs, 0.0, 1.0);
      	} else {
      		// The vertex is not lit by the spotlight, so set the reflection to black
      		R = vec3(0.0, 0.0, 0.0);
      	}

      	gl_Position =  projectionMatrix * modelViewMatrix * vertexPosition;
      }
    </script>

    <script id="fragment-shader" type="x-shader/x-fragment">
      precision mediump float;
      varying vec3 R;
      void main() {
      	gl_FragColor = vec4( R.r, R.g, R.b, 1.0 );
      }
    </script>

    <script type="text/javascript" src="../Common/webgl-utils.js"></script>
    <script type="text/javascript" src="../Common/initShaders.js"></script>
    <script type="text/javascript" src="../Common/MV.js"></script>
    <script type="text/javascript" src="lab4.js"></script>
    <script type="text/javascript" src="object.js"></script>
  </head>

  <body onload="initGL()">
    <canvas id="gl-canvas" height="512" width="512"> </canvas>
    <div>
      <button id="orthographicButton" onclick="orthographic()">
        Orthographic
      </button>
      <button id="perspectiveButton" onclick="perspective()">
        Perspective
      </button>
    </div>
    <br />
    <div>
      <button id="light1Button" onclick="light1()">Light 1</button>
      <button id="light2Button" onclick="light2()">Light 2</button>
      <button id="specularButton" onclick="specular()">Specular</button>
    </div>
  </body>
</html>
